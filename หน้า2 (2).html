<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</title>
<style>
*{box-sizing:border-box;font-family:sans-serif}
body{margin:0;background:#ffb6d9;min-height:100vh;padding:20px 60px 80px 20px}
h2{text-align:center;color:#fff}
.top{display:flex;gap:10px;margin-bottom:15px}
input,button{padding:10px;border-radius:10px;border:none;font-weight:bold}
button{background:#ff4d94;color:#fff;cursor:pointer}
.room-list{display:flex;flex-direction:column;gap:12px}
.room{background:#fff;border-radius:12px;padding:12px;box-shadow:0 4px 10px rgba(0,0,0,.2);cursor:pointer}
.hidden{display:none}
.container{max-width:900px;margin:auto}
.room-header{display:flex;justify-content:space-between;align-items:center;background:#1c1c1c;padding:10px 15px;border-radius:10px;color:#fff}
.owner-controls button{background:#00ff99;color:#000;margin-left:5px}
.camera-area{margin-top:15px;background:#000;border-radius:12px;height:220px;display:none;align-items:center;justify-content:center}
.camera-area video{width:100%;height:100%;object-fit:cover;border-radius:12px}
.chat-box{margin-top:10px;background:#1c1c1c;border-radius:10px;padding:10px;height:200px;overflow-y:auto;color:#fff;display:flex;flex-direction:column-reverse}
.chat-input{display:flex;margin-top:10px;gap:10px}
.chat-input input{flex:1}
#bottomNav{
    position:fixed;bottom:0;left:0;width:100%;background:#ff4d94;
    display:flex;justify-content:space-around;padding:10px 0;
    border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -3px 10px rgba(0,0,0,0.2);
}
#bottomNav button{flex:1;color:#fff;font-weight:bold;background:none;border:none;cursor:pointer}
</style>
</head>
<body>

<h2>à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡</h2>

<div id="listBox">
    <div class="top">
        <input id="search" placeholder="à¸„à¹‰à¸™à¸«à¸² ID à¸«à¸£à¸·à¸­à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡">
        <button onclick="renderRooms()">ğŸ” à¸„à¹‰à¸™à¸«à¸²</button>
        <button onclick="showOpen()">â• à¹€à¸›à¸´à¸”à¸«à¹‰à¸­à¸‡</button>
    </div>
    <div id="roomList" class="room-list"></div>
</div>

<div id="openBox" class="hidden">
    <input id="roomName" placeholder="à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡">
    <input id="roomId" placeholder="ID à¸«à¹‰à¸­à¸‡ (8 à¸•à¸±à¸§)">
    <button onclick="setLock(false)">ğŸ”“ à¹„à¸¡à¹ˆà¸¥à¹‡à¸­à¸„</button>
    <button onclick="setLock(true)">ğŸ”’ à¸¥à¹‡à¸­à¸„</button>
    <input id="roomPass" class="hidden" placeholder="à¸£à¸«à¸±à¸ª 6 à¸•à¸±à¸§">
    <button onclick="openRoom()">à¹€à¸›à¸´à¸”à¸«à¹‰à¸­à¸‡</button>
    <button onclick="back()">â¬… à¸à¸¥à¸±à¸š</button>
</div>

<div id="roomBox" class="hidden container">
    <div class="room-header">
        <div>
            <b id="showRoomName"></b>
            <div style="font-size:13px;color:#aaa">
                ID à¸«à¹‰à¸­à¸‡: <span id="showRoomId"></span> | ğŸ‘¥ <span id="showRoomCount">0</span> à¸„à¸™
            </div>
        </div>
        <div id="ownerControls" class="owner-controls hidden">
            <button onclick="toggleCam()">ğŸ¥ à¸à¸¥à¹‰à¸­à¸‡</button>
            <button onclick="closeRoom()">âŒ à¸›à¸´à¸”à¸«à¹‰à¸­à¸‡</button>
        </div>
    </div>
    <div id="cameraArea" class="camera-area">
        <video id="cameraVideo" autoplay playsinline></video>
    </div>
    <div id="chatBox" class="chat-box"></div>
    <div class="chat-input">
        <input id="chatInput" placeholder="à¸à¸´à¸¡à¸à¹Œà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡...">
        <button onclick="sendChat()">à¸ªà¹ˆà¸‡</button>
        <button onclick="exitRoom()">à¸­à¸­à¸</button>
    </div>
</div>

<div id="bottomNav">
    <button onclick="showPage('home')">ğŸ  à¸«à¸™à¹‰à¸²à¹à¸£à¸</button>
    <button onclick="showPage('chat')">ğŸ’¬ à¹à¸Šà¸—</button>
    <button onclick="showPage('account')">ğŸ‘¤ à¸šà¸±à¸à¸Šà¸µ</button>
</div>

<script>
let locked=false,currentRoomId=null,camOn=false,cameraStream=null;
let username=localStorage.getItem("username");
if(!username){username=prompt("à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸‚à¸­à¸‡à¸„à¸¸à¸“");localStorage.setItem("username",username);}

const roomList=document.getElementById("roomList");
const search=document.getElementById("search");

// ===== SYNC FUNCTION =====
function syncRooms(){
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    // à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡
    if(currentRoomId){
        const room=rooms.find(r=>r.id===currentRoomId);
        if(room){
            showRoomCount.innerText=room.users.length;
            renderChat(room);
            if(room.owner!==username){ // à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹€à¸ˆà¹‰à¸²à¸‚à¸­à¸‡
                cameraArea.style.display=room.camOn?"flex":"none";
            }
        }
    }
    renderRoomsList(rooms);
}
function renderRoomsList(rooms){
    const filter = search.value.trim().toLowerCase();
    roomList.innerHTML="";
    rooms.filter(r=>r.name.toLowerCase().includes(filter)||r.id.toLowerCase().includes(filter))
        .forEach(r=>{
        const d=document.createElement("div");
        d.className="room";
        d.innerHTML=`<b>${r.name}</b><br><small>ID: ${r.id} | ğŸ‘¥ ${r.users.length} à¸„à¸™ | ${r.locked?"ğŸ”’ à¸¥à¹‡à¸­à¸„":"ğŸ”“ à¹„à¸¡à¹ˆà¸¥à¹‡à¸­à¸„"}</small>`;
        d.onclick=()=>enterRoom(r.id);
        roomList.appendChild(d);
    });
}

// ===== RENDER CHAT =====
function renderChat(room){
    chatBox.innerHTML="";
    room.chats.slice().reverse().forEach(c=>{
        const d=document.createElement("div");
        d.innerText=c;
        chatBox.appendChild(d);
    });
}

// ===== OPEN / BACK =====
function showOpen(){listBox.classList.add("hidden");openBox.classList.remove("hidden");}
function back(){openBox.classList.add("hidden");listBox.classList.remove("hidden");}
function setLock(l){locked=l;roomPass.classList.toggle("hidden",!l);}

// ===== CREATE ROOM =====
function openRoom(){
    const name=roomName.value.trim(),id=roomId.value.trim(),pass=roomPass.value.trim();
    if(!name||id.length!==8) return alert("à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
    if(locked&&pass.length!==6) return alert("à¸£à¸«à¸±à¸ªà¸•à¹‰à¸­à¸‡ 6 à¸•à¸±à¸§");

    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    if(rooms.some(r=>r.id===id)) return alert("ID à¸«à¹‰à¸­à¸‡à¸™à¸µà¹‰à¸–à¸¹à¸à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹à¸¥à¹‰à¸§");

    rooms.push({id,name,locked,password:locked?pass:"",owner:username,users:[username],chats:[],camOn:false});
    localStorage.setItem("rooms",JSON.stringify(rooms));
    renderRooms();
    enterRoom(id);
}

// ===== ENTER ROOM =====
function enterRoom(id){
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    const room=rooms.find(r=>r.id===id);
    if(!room) return;
    if(room.locked){
        const p=prompt("à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡");
        if(p!==room.password) return alert("à¸£à¸«à¸±à¸ªà¸œà¸´à¸”");
    }
    if(!room.users.includes(username)) room.users.push(username);
    localStorage.setItem("rooms",JSON.stringify(rooms));
    currentRoomId=id;

    listBox.classList.add("hidden"); openBox.classList.add("hidden"); roomBox.classList.remove("hidden");
    showRoomName.innerText=room.name+(room.locked?" ğŸ”’":""); showRoomId.innerText=room.id;
    ownerControls.classList.toggle("hidden",room.owner!==username);

    cameraArea.style.display=(room.owner===username && room.camOn)?'flex':'none';
    renderChat(room);
}

// ===== CHAT =====
function sendChat(){
    if(!chatInput.value) return;
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    const room=rooms.find(r=>r.id===currentRoomId);
    room.chats.push(username+": "+chatInput.value);
    if(room.chats.length>5) room.chats.shift();
    localStorage.setItem("rooms",JSON.stringify(rooms));
    renderChat(room);
    chatInput.value="";
}

// ===== CAM =====
function toggleCam(){
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    const room=rooms.find(r=>r.id===currentRoomId);
    if(!room||room.owner!==username) return;
    if(!camOn){
        navigator.mediaDevices.getUserMedia({video:true}).then(s=>{
            cameraStream=s; cameraVideo.srcObject=s; cameraArea.style.display="flex"; camOn=true;
            room.camOn=true; localStorage.setItem("rooms",JSON.stringify(rooms));
        });
    }else{
        cameraStream.getTracks().forEach(t=>t.stop());
        cameraVideo.srcObject=null; cameraArea.style.display="none"; camOn=false;
        room.camOn=false; localStorage.setItem("rooms",JSON.stringify(rooms));
    }
}

// ===== CLOSE / EXIT =====
function closeRoom(){
    if(!confirm("à¸›à¸´à¸”à¸«à¹‰à¸­à¸‡?")) return;
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    rooms=rooms.filter(r=>r.id!==currentRoomId);
    localStorage.setItem("rooms",JSON.stringify(rooms));
    currentRoomId=null; roomBox.classList.add("hidden"); listBox.classList.remove("hidden");
}
function exitRoom(){
    if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop()); camOn=false;
    let rooms=JSON.parse(localStorage.getItem("rooms")||"[]");
    const room=rooms.find(r=>r.id===currentRoomId);
    if(room) room.users=room.users.filter(u=>u!==username);
    localStorage.setItem("rooms",JSON.stringify(rooms));
    currentRoomId=null; roomBox.classList.add("hidden"); listBox.classList.remove("hidden");
}

// ===== BOTTOM NAV =====
function showPage(page){
    if(page==="home"){listBox.classList.remove("hidden"); roomBox.classList.add("hidden"); openBox.classList.add("hidden");}
    else if(page==="chat"){alert("à¸«à¸™à¹‰à¸²à¹à¸Šà¸—à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹à¸¢à¸ (à¹€à¸‚à¹‰à¸²à¸œà¹ˆà¸²à¸™à¸«à¹‰à¸­à¸‡à¹„à¸”à¹‰)");}
    else if(page==="account"){alert("à¸šà¸±à¸à¸Šà¸µà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰: "+username);}
}

// ===== REALTIME SYNC =====
setInterval(syncRooms,1000);
renderRooms();
</script>
</body>
</html>